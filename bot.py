import os
import random
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    CallbackContext,
    ConversationHandler,
    MessageHandler,
    filters,
)

# ุฌูุจ ุชููู ุงูุจูุช ูู ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
TOKEN = os.getenv("TOKEN")
if not TOKEN:
    raise ValueError("No TOKEN provided. Please set the TOKEN environment variable.")

# ุญุงูุงุช ุงููุญุงุฏุซุฉ
DAY_SELECTION, MEMORIZE, TEST = range(3)

# ุงููุต ุงูุฃุณุงุณู ุงูุฐู ูุจุฏุฃ ุจู ูู ููู
BASE_TEXT = "ูุงู ูููุงูุง ุดูุณ ุงูุฒูุงู ุงูุฅูุงู ุทุงุฑู ุจู ูุญูุฏ ุงูุณุนุฏู ูุฏุณ ุงููู ุณุฑู ุงูุนูู:"

# ูุงุฆูุฉ ุงููููุงุช ูู 30 ููููุง (ุงูุฌุฒุก ุจุนุฏ "ุงูุนูู:" ููุท)
WORDS = [
    "ููุฏุงุฑ ุฑุญูุฉ ุงูุจุฑูุฉ ุจูุฏุฑ ูุง ูู ูููุจูู ูู ุงููุญุจุฉ ุงูุญูุฉ",  # ุงูููู 1
    "ุงูุนุจุงุฏุฉู ูุตุฏุฑู ูู ูุตุงุฏุฑู ุตุญูุฉู ุญูุงุฉู ุงูุฌูู ูุงูุฅูุณ",  # ุงูููู 2
    "ุงูุฅูุซุงุฑ ุฎููู ุฃุดุงุฏ ุจู ุงููุงุญุฏ ุงููููุงุฑุ ูุญุจูุจู ุงููุฎุชุงุฑุ ูุฎููุงุคู ุงูุฃุฎูุงุฑ",  # ุงูููู 3
    "ุงูููุฑูุฏ ูููู ุฅูู ุดูุฎู ุฃูุฑุจ ููู ุฅูู ููุณูุ ููุง ููุฎูู ุนูู ุดุงุฑุฏุฉ ููุง ูุงุฑุฏุฉ",  # ุงูููู 4
    "ุฅูุฐูุง ุฃูุฑูุฏูุชู ุฃููู ูููููููู ุงูููู ุชูุนูุงููู ููุนูู! ููุงุณูุชููููู ููููุง ุฃูููุฑููุ ููุงุชูููู ููุง ููุชูููู",  # ุงูููู 5
    "ูุง ูุฒุงู ุงููู ูุชุฌูููู ุนูู ุงูุจุฑูููุฉ ุนููููุง ูุฎุตูุตูุงุ ูู ุจุฏุงูุฉู ุงูุชููููููู ุฅูู ุฃุจุฏู ุงูุขุจุฏูููู",  # ุงูููู 6
    "ุงูุญูุงุฉ ุงูุฏููููุง ูููุง ูุงุฏุฉ ุฌูุฑุซูููููุฉ! ุชูููุช ุฎูููู ูุฎูููู ุงููููุงุณุ ุจุญุณุจ ููุฏูุฑูุง ูู ูููุณูู",  # ุงูููู 7
    "ูุซุฑุฉ ุงูุฒูููุ ุชูุญุฏูุซ ุงูุฎูููุ ูุชููุน ุงูุนูู",  # ุงูููู 8
    "ุงููุถูู ูู ุนูุงุฆู ุงููุตูู",  # ุงูููู 9
    "ุจุงูููุญูุจููุฉ ุชูุชูุญููููู ุงูุญููุงุฉุ ูุจุงููุนูุฏุงูููุง ุชูุญูุตูู ุงูุขูุงุช",  # ุงูููู 10
    "ูุง ููุฒูุงูู ุงููููุชูุตูููููู ุนูููู ุงููุนูููุฏู ููู ุงููููุฑูุจูุงู ุญูุชููู ููุตูููููููู ุงููุฑููุญูููู",  # ุงูููู 11
    "ุฃูุตููู ุงูุฅูุบูุฑูุงุกู: ููุชูููุฉู ุงููููุฑูุกู ุจูุงููุดููููููุงุชู",  # ุงูููู 12
    "ุฃูุตููู ุงูุฅูุบูููุงุกู: ููุชูููุฉู ุงููููุฑูุกู ุจูุงููููููุณูุฏูุงุชู",  # ุงูููู 13
    "ุงููููุชูุตูููููู: ุบูุฑูููุจู ุงูุฃูููููุงูุ ูุง ููุฒูุงูู ููุนูุจูุฑููุง ุจูุฅูุญูุณูุงููุ ุญูุชููู ููุตูููููููู ุงูุฑููุญููููู",  # ุงูููู 14
    "ุงูุงุฎูุชูุจูุงุฑู ุฏูุนูููุฉู ููุชูุตูุญูููุญู ุงูููุณูุงุฑู ุจุงูุงุนูุชูุจูุงุฑ",  # ุงูููู 15
    "ุนูุฏููู ุงูุงุนูุชูุจูุงุฑู ูููู ุงูุฅุตูุฑูุงุฑู ููุงูุงุณูุชูููุจูุงุฑ",  # ุงูููู 16
    "ุนูู ููุฏูุฑู ุญูุถูุฑ ุงูุฌูุงู ููุชูุน ุงูุนุจุฏ ุจูููุถ ุงูุฑุญูู",  # ุงูููู 17
    "ุฅููุงู ุงูุฃููุงู: ุณูููู ุฅูู ุงููุงุญุฏ ุงูููุชุนุงูุ ููุง ุชูููุง ุนูู ุงููู ุชุนุงูู ูุง ุฃุนุทุงููุ ููุง ุชูุจุถูุง ุงููุฏ ูููุง ุงุดุชุฑุงู ูููู ุฅุฐ ุงุดุชุฑุงูู",  # ุงูููู 18
    "ุงูููุทูููููุจู: ุฅูุฏูุฑูุงูู ููุง ูุง ุจูุฏูู ูููููู ููู ุงูุทููุงุนูุฉู ููุงูุงุณูุชูููุงููุฉู ูููู ุนููุงูู ุงูุบูููููุจู",  # ุงูููู 19
    "ููุญูููุธู ุงููุนููููู ุจูุงููููููุฑูุ ููุงูุงุณูุชูููุงููุฉู ุจูุงููุฐููููุฑูุ ููุงููุฒููููุงุฏูุฉู ุจูุงููุดููููุฑู",  # ุงูููู 20
    "ุงููุณููุงูููู ุฅูููู ุนููููุงูู ุงูุบูููููุจู: ููุนูุฒููู ุนูููู ุญูููุธู ุงูููุทูููููุจูุ ููููุฌูุงููุฏูุฉู ุงููุฎูุทูููุจูุ ููุงูุงุชููููุงุกู ุจูุงููููุญูุจูููุจู",  # ุงูููู 21
    "ุงูุนูุงูููู ุงููููููุฑูู: ููุจูููู ุฃูุญูููุงูููู ุนูููู ุงููููุญููููุ ุงุจูุชูุบูุงุกู ููุฌููู ุฑูุจูููู ุงูุฃูุญููููู",  # ุงูููู 22
    "ุงููุนุตูุฉ ูุงูุซูุฑุ ุชุญูู ูู ููุณูุง ุงูุถุฑุฑ! ูุฅุฐุง ุชุนุงุทุงูุง ุงูุนุงุตู ุฃููุน ููุณู ูู ุงูุฎุทุฑ",  # ุงูููู 23
    "ุงูุฑููุญูููููุฉ ุชููุชุนูููู ุจุงูุดูุก ุฅูููุง ูููุฑูููุนูู ุฃู ููุฑููุนู",  # ุงูููู 24
    "ุฏููููููู ููุฑูุจููู ูููู ุงูููู ุชูุนูุงููู: ุชูููุฑููุจููู ููููุฑูุจููู ูููู ุงููุนูุจูุงุฏูุฉ",  # ุงูููู 25
    "ุฏููููููู ููุญูุจููุชููู ูููู ุงูุนูุธูููู: ููุญูุจููุชููู ููุนูุจูุงุฏูุชููู ุนูููู ุงูุตููุฑูุงุทู ุงูููุณูุชูููููู",  # ุงูููู 26
    "ุจููุฏูุฑ ุญูุถููุฑูู ููุนุธูู ูููุฑูู",  # ุงูููู 27
    "ุจูุฏุฑ ุจูุนุฏู ุนู ุงูููุฎุงููุงุช ูุชููุฏููุฑู ููุทุงุนุงุช ุชูุญูุถุฑ ูู ุงูุนูุจูุงุฏุงุช",  # ุงูููู 28
    "ุนูู ูุฏุฑู ุงูุงุณุชูุนูุฏุงุฏ ููููู ุงูุฅููุฏุงุฏ",  # ุงูููู 29
    "ุฃูุงู ุงูุฃุญูุงู ุจุญูุธ ุงูููุงู",  # ุงูููู 30
]

# ุฏูุฌ ุงููุต ุงูุฃุณุงุณู ูุน ุงููููุงุช ูุนุฑุถูุง ุนูุฏ ุงุฎุชูุงุฑ ุงูููู
FULL_WORDS = [f"{BASE_TEXT} {word}" for word in WORDS]

# ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู
user_data = {}

# ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
async def start(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    if user_id not in user_data:
        user_data[user_id] = {"memorized_words": []}

    context.user_data.clear()
    context.user_data["current_words"] = FULL_WORDS
    await show_days(update, context)
    return DAY_SELECTION

async def show_days(update: Update, context: CallbackContext):
    user_id = update.callback_query.from_user.id if update.callback_query else update.message.from_user.id
    words = context.user_data["current_words"]

    keyboard = []
    for i in range(0, 30, 3):
        row = [
            InlineKeyboardButton(
                f"ุงูููู {i+1}{' โ' if words[i] in user_data[user_id]['memorized_words'] else ''}",
                callback_data=f"day_{i}"
            ),
            InlineKeyboardButton(
                f"ุงูููู {i+2}{' โ' if words[i+1] in user_data[user_id]['memorized_words'] else ''}",
                callback_data=f"day_{i+1}"
            ) if i + 1 < len(words) else None,
            InlineKeyboardButton(
                f"ุงูููู {i+3}{' โ' if words[i+2] in user_data[user_id]['memorized_words'] else ''}",
                callback_data=f"day_{i+2}"
            ) if i + 2 < len(words) else None,
        ]
        keyboard.append([btn for btn in row if btn])

    if user_data[user_id]["memorized_words"]:
        keyboard.append([InlineKeyboardButton("๐ ูุฑุงุฌุนุฉ", callback_data="review")])
        keyboard.append([InlineKeyboardButton("๐ ุงุฎุชุจุงุฑ ุดุงูู", callback_data="test_all")])

    reply_markup = InlineKeyboardMarkup(keyboard)
    message = (
        "๐ *ุฑุญูุฉ ุญูุธ ุงููููุงุช ุงูุนููุฉ ูู ุดูุฑ ุฑูุถุงู ุงููุจุงุฑู* ๐\n\n"
        "โจ ุงูุทูู ูู ูุบุงูุฑุฉ ููููุฉ ูุน ูููุงุช ุงูุญููุฉ ูุงููุนุฑูุฉ ูู ุดูุฑ ุงูุฎูุฑ\n"
        "๐ ุงุฎุชุฑ ุงูููู ูุงุญูุธ ุงููููุฉ ุซู ุงุถุบุท *ุชู ุงูุญูุธ* ๐\n"
        "๐ ุงุณุชูุชุน ุจูุฑุงุฌุนุฉ ูููุฒู ุงููุญููุธุฉ ุนุจุฑ ุฒุฑ *ูุฑุงุฌุนุฉ* โจ\n"
        "๐ ุฃู ุชุญุฏูู ููุณู ุจุงุฎุชุจุงุฑ ุดุงูู ูู ุฎูุงู ุฒุฑ *ุงุฎุชุจุงุฑ ุดุงูู* ๐"
    )
    if update.callback_query:
        await update.callback_query.edit_message_text(message, reply_markup=reply_markup, parse_mode="Markdown")
    else:
        await update.message.reply_text(message, reply_markup=reply_markup, parse_mode="Markdown")
    return DAY_SELECTION

# ุนุฑุถ ุงููููุฉ ููุญูุธ ุฃู ุงููุฑุงุฌุนุฉ
async def select_day(update: Update, context: CallbackContext):
    await update.callback_query.answer()
    user_id = update.callback_query.from_user.id
    day_index = int(update.callback_query.data.split("_")[1])
    words = context.user_data["current_words"]
    word = words[day_index]

    if word in user_data[user_id]["memorized_words"]:
        keyboard = [
            [InlineKeyboardButton("๐ ุฑุฌูุน", callback_data="back_to_days")],
        ]
    else:
        keyboard = [
            [InlineKeyboardButton("โ ุชู ุงูุญูุธ", callback_data=f"memorize_{day_index}")],
            [InlineKeyboardButton("๐ ุฑุฌูุน", callback_data="back_to_days")],
        ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.callback_query.edit_message_text(
        f"๐ *ุงูููู {day_index + 1}*\n\n{word}",
        reply_markup=reply_markup,
        parse_mode="Markdown",
    )
    return MEMORIZE

# ูุนุงูุฌุฉ ุงูุญูุธ
async def memorize
